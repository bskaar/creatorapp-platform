<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Stripe Setup</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Stripe Setup Verification</h1>

    <div class="space-y-6">
      <!-- Price Verification -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">1. Verify Prices in Stripe</h2>
        <div class="space-y-2 text-sm">
          <p>✅ Growth Plan Price ID: <code class="bg-gray-100 px-2 py-1 rounded">price_1SNjksK3D1fY78V9S8SrPFFn</code></p>
          <p>✅ Pro Plan Price ID: <code class="bg-gray-100 px-2 py-1 rounded">price_1SNjljK3D1fY78V90o4deWwj</code></p>
        </div>
        <div class="mt-4 p-4 bg-blue-50 rounded">
          <p class="font-semibold mb-2">Verify in Stripe Dashboard:</p>
          <ol class="list-decimal ml-6 space-y-1 text-sm">
            <li>Go to <a href="https://dashboard.stripe.com/test/products" target="_blank" class="text-blue-600 underline">Test Products</a></li>
            <li>Click on each product and verify:
              <ul class="list-disc ml-6 mt-1">
                <li>The price is set to <strong>Recurring</strong> (not one-time)</li>
                <li>The billing period is <strong>Monthly</strong></li>
                <li>The price is <strong>Active</strong> (not archived)</li>
              </ul>
            </li>
          </ol>
        </div>
      </div>

      <!-- Webhook Verification -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">2. Configure Webhook Endpoint</h2>
        <div class="space-y-3">
          <div class="p-4 bg-yellow-50 border border-yellow-200 rounded">
            <p class="font-semibold mb-2">⚠️ Important: Set up webhook to receive payment confirmations</p>
            <ol class="list-decimal ml-6 space-y-2 text-sm">
              <li>Go to <a href="https://dashboard.stripe.com/test/webhooks" target="_blank" class="text-blue-600 underline">Webhooks</a></li>
              <li>Click <strong>"Add endpoint"</strong></li>
              <li>Enter this URL: <code class="bg-gray-100 px-2 py-1 rounded text-xs">https://yhofzxqopjvrfufouqzt.supabase.co/functions/v1/stripe-webhook</code></li>
              <li>Under "Select events to listen to", choose:
                <ul class="list-disc ml-6 mt-1">
                  <li><code>checkout.session.completed</code></li>
                  <li><code>customer.subscription.created</code></li>
                  <li><code>customer.subscription.updated</code></li>
                  <li><code>customer.subscription.deleted</code></li>
                </ul>
              </li>
              <li>Click <strong>"Add endpoint"</strong></li>
              <li>Copy the <strong>"Signing secret"</strong> (starts with <code>whsec_</code>)</li>
              <li>You need to add this to your environment as <code>STRIPE_WEBHOOK_SECRET</code></li>
            </ol>
          </div>
        </div>
      </div>

      <!-- Test Checkout -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">3. Test Checkout Session</h2>
        <button id="testBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
          Test Pro Plan Checkout
        </button>
        <div id="result" class="mt-4"></div>
      </div>

      <!-- Direct Stripe Test -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">4. Quick Stripe API Test</h2>
        <p class="text-sm text-gray-600 mb-4">Test if your Stripe Secret Key can access the prices:</p>
        <div class="space-y-2">
          <input type="password" id="stripeKey" placeholder="sk_test_..." class="w-full border rounded px-4 py-2 text-sm">
          <button id="testApiBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
            Test Stripe API
          </button>
        </div>
        <div id="apiResult" class="mt-4"></div>
      </div>
    </div>
  </div>

  <script>
    const testBtn = document.getElementById('testBtn');
    const result = document.getElementById('result');
    const testApiBtn = document.getElementById('testApiBtn');
    const apiResult = document.getElementById('apiResult');
    const stripeKeyInput = document.getElementById('stripeKey');

    testBtn.addEventListener('click', async () => {
      result.innerHTML = '<p class="text-blue-600">Testing checkout session creation...</p>';

      try {
        // This would need authentication - just showing the concept
        result.innerHTML = '<p class="text-orange-600">⚠️ To test checkout, log in to your app and try subscribing to the Pro plan.</p>';
      } catch (error) {
        result.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
      }
    });

    testApiBtn.addEventListener('click', async () => {
      const stripeKey = stripeKeyInput.value.trim();

      if (!stripeKey) {
        apiResult.innerHTML = '<p class="text-red-600">Please enter your Stripe Secret Key</p>';
        return;
      }

      apiResult.innerHTML = '<p class="text-blue-600">Testing Stripe API...</p>';

      try {
        // Test fetching the price
        const priceId = 'price_1SNjljK3D1fY78V90o4deWwj';
        const response = await fetch(`https://api.stripe.com/v1/prices/${priceId}`, {
          headers: {
            'Authorization': `Bearer ${stripeKey}`
          }
        });

        if (response.ok) {
          const price = await response.json();
          apiResult.innerHTML = `
            <div class="p-4 bg-green-50 border border-green-200 rounded">
              <p class="font-semibold text-green-800">✅ Stripe API Working!</p>
              <div class="mt-2 text-sm space-y-1">
                <p>Price ID: ${price.id}</p>
                <p>Amount: $${(price.unit_amount / 100).toFixed(2)}</p>
                <p>Type: ${price.type}</p>
                <p>Active: ${price.active ? 'Yes' : 'No'}</p>
                ${price.recurring ? `<p>Recurring: ${price.recurring.interval}ly</p>` : '<p class="text-red-600">⚠️ Not a recurring price!</p>'}
              </div>
            </div>
          `;
        } else {
          const error = await response.json();
          apiResult.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded">
              <p class="font-semibold text-red-800">❌ Stripe API Error</p>
              <p class="text-sm mt-2">${error.error?.message || 'Unknown error'}</p>
            </div>
          `;
        }
      } catch (error) {
        apiResult.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
      }
    });
  </script>
</body>
</html>
